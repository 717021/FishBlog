var main=new Vue({el:"#main",data:{message:"Hello Vue.js!",currentPostIdOrName:null,currentPostId:0,isLoading:!1,isLoaded:!1,loadFailed:!1,laodErr:"",authed:!1,authedUserId:-1,authedUserInfo:null,authedUserLiked:!1,postTags:null,postContent:null,postContentWithHtml:null,postCanComment:!1,prvPostTitle:"没有了",nextPostTitle:"没有了",hasPrvPost:!1,hasNextPost:!1,previewCommentItem:null},methods:{loadPost:function(){var currentPostPage=getQueryString("post");if(null==currentPostPage&&(currentPostPage=getLastUrlAgrs(location.href).arg),this.currentPostIdOrName=currentPostPage,isNullOrEmpty(this.currentPostIdOrName)||"post"==currentPostPage)main.isLoading=!1,main.laodErr="没有找到指定的文章",main.loadFailed=!0;else{var url=address_blog_api+"post/"+this.currentPostIdOrName;this.isLoading=!0,$.ajax({url:url,success:function(response){main.isLoading=!1,response.success?(main.postContent=response.data,main.currentPostId=response.data.id,main.postTags=response.data.postTagNames,main.postContent.enableComment&&(main.postCanComment=!0),main.reloadPostStats(),main.generatePostContent(),main.initComment(),main.isLoaded=!0,main.updateViewCount()):(main.laodErr=response.message,main.loadFailed=!0)},error:function(xhr,err){main.isLoading=!1,main.laodErr=err,main.loadFailed=!0}})}},generateHtml:function(){var a=null;if("html"==this.postContent.type)a=base64.decode(this.postContent.content);else if("markdown"==this.postContent.type){var b;a=base64.decode(this.postContent.content),a=(new showdown.Converter).makeHtml(a)}else"txt"==this.postContent.type&&(a=this.postContent.content);this.postContentWithHtml=a},generatePostContent:function(){this.generateHtml(),this.postContent.postPrvTitle&&(this.prvPostTitle=this.postContent.postPrvTitle,this.hasPrvPost=!0),this.postContent.postNextTitle&&(this.nextPostTitle=this.postContent.postNextTitle,this.hasNextPost=!0),this.postContent.headimgMask,$("title").text(this.postContent.title+" - ALONE SPACE"),setTimeout(function(){$("#post_content pre code").each(function(i,block){$(this).html(replaceBlockBadChr($(this).html())),$(this).parent().before($('<div class="bd-clipboard"><button class="btn-clipboard" title data-original-title="复制到剪贴板">复制</button></div>')),hljs.highlightBlock(block)}),$(".btn-clipboard").tooltip(),$("#post_content img").each(function(i,block){var dsrc=$(this).attr("data-src");isNullOrEmpty(dsrc)||$(this).attr("src",getImageUrlFormHashWithType(dsrc,$(this).attr("data-image-type"))),(!this.complete||void 0!==this.naturalWidth&&0==this.naturalWidth)&&$(this).bind("error.replaceSrc",function(){$(this).attr("src","/images/img_failed.png"),$(this).attr("style","width: 250px"),$(this).unbind("error.replaceSrc")}).trigger("load"),this.complete&&void 0!==this.naturalWidth&&0==this.naturalWidth&&($(this).attr("src","/images/img_failed.png"),$(this).attr("style","width: 250px"))}),$("#post_content img").click(function(){BigPicture({el:$(this).get(0),imgSrc:$(this).attr("src")})}),$('[data-toggle="tooltip"]').tooltip(),$('[data-toggle="popover"]').popover(),main.generateCatalog()},500),setTimeout(function(){isNullOrEmpty(location.hash)||scrollToEle(decodeURI(location.hash))},1500)},generateCatalog:function(){var P,a,n,t,l,i,c,id;a=$("div.post-container").find("h1,h2,h3,h4,h5,h6");var $catalog_body=$("#catalog_content"),$catalog_scroller=$("#side_catalog");a.each(function(){n=$(this).prop("tagName").toLowerCase(),$(this).attr("id",$(this).text().replace(/(!|\"|#|\$|%|&|\'|\(|\)|\*|\+|\?|\^|\{|\}|,|\.|\/|:|;|<|=|>|@|\[|\]|\(|\)|`|\\|~| ){1}/g,"-")),i="#"+$(this).prop("id"),t=$(this).text(),c=$('<a href="'+i+'" rel="nofollow">'+t+"</a>"),l=$('<li class="'+n+'_nav"></li>').append(c),$catalog_body.append(l)}),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),$catalog_body.onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:-70,scrollThreshold:.2,begin:null,end:null,scrollChange:function($parent){}}),anchors.add().remove(".blog-content h1").remove(".no-anchor").remove(".sidebar-container h5");var width=$(window).width(),catalog_floated=!1,catalog_bottom_pined=!1,$post_content_end=$("#post_content_end"),$side_catalog=$("#side_catalog"),old_catalog_top=$side_catalog.offset().top-65;function catalogScroll(){width>=992?$(document).scrollTop()>=old_catalog_top&&!catalog_floated?($side_catalog.addClass("side-catalog-fixed"),catalog_floated=!0):$(document).scrollTop()<=old_catalog_top&&catalog_floated?($side_catalog.removeClass("side-catalog-fixed"),catalog_floated=!1):$(document).scrollTop()>$post_content_end.offset().top-$side_catalog.height()-60&&!catalog_bottom_pined?($side_catalog.removeClass("side-catalog-fixed").attr("style","position: absolute; top: auto; bottom: 0px;"),catalog_bottom_pined=!0,catalog_floated=!0):$(document).scrollTop()<=$post_content_end.offset().top-$side_catalog.height()-60&&catalog_bottom_pined&&($side_catalog.attr("style",""),catalog_bottom_pined=!1,catalog_floated=!1):($side_catalog.addClass("side-catalog-fixed"),$(document).scrollTop()>$post_content_end.offset().top-200&&!catalog_bottom_pined?($("#side_catalog_on_toggle").fadeOut(),$("body").hasClass("side-catalog-mobile-active")&&($("body").removeClass("side-catalog-mobile-active"),$("#side_catalog").removeClass("side-catalog-slidein")),catalog_bottom_pined=!0):$(document).scrollTop()<=$post_content_end.offset().top-200&&catalog_bottom_pined&&(catalog_bottom_pined=!1,$("#side_catalog_on_toggle").fadeIn()))}catalogScroll(),$(document).scroll(function(e){catalogScroll()}),$(window).resize(function(){width=$(window).width()}),$(document).click(function(e){var container=$("#side_catalog, #side_catalog_close_toggle, #side_catalog_on_toggle");container.is(e.target)||0!==container.has(e.target).length||$("body").hasClass("side-catalog-mobile-active")&&($("body").removeClass("side-catalog-mobile-active"),$("#side_catalog").removeClass("side-catalog-slidein"))})},switchCatalog:function(){$("#side_catalog").toggleClass("side-catalog-slidein"),$("body").toggleClass("side-catalog-mobile-active")},initComment:function(){this.postContent.enableComment&&setTimeout(function(){setTimeout(function(){main.$refs.postComment.loadLastUserInfo()},1500);var postHeight=$("#comment").offset().top,commentFirstLoaded=!1;$(document).scroll(function(e){$(document).scrollTop()>=postHeight-300&&!commentFirstLoaded&&(main.$refs.postComment.loadPostComment(),commentFirstLoaded=!0)})},500)},updateViewCount:function(){setTimeout(function(){document.referrer!=document.location.toString()&&$.get(address_blog_api+"post/updateViewCount?id="+main.currentPostId)},1500)},updateLikeCount:function(){this.authed?$.ajax({url:address_blog_api+"post/updateLikeCount?id="+main.currentPostId+(main.authedUserLiked?"&like=false":"&like=true"),success:function(response){response.success?(main.authedUserLiked=!main.authedUserLiked,main.postContent&&void 0!==main.postContent.likeCount&&(main.postContent.likeCount+=main.authedUserLiked?1:-1)):489==response.code&&toast(response.message,"info",5e3)}}):this.showFastLogin()},reloadPostStats:function(){$.ajax({url:address_blog_api+"posts/stat/"+main.currentPostId,type:"get",contentType:"application/json; charset=utf-8",dataType:"json",success:function(response){response.success&&(main.postContent.viewCount=response.data.viewCount,main.postContent.commentCount=response.data.commentCount,main.postContent.likeCount=response.data.likeCount,response.data.currentUserLiked&&(main.authedUserLiked=!0))},error:function(xhr,err){}})},share:function(type){},showFastLogin:function(){this.$refs.postComment.showFastLogin()},getNextPostUrl:function(){return 0!=this.postContent.postNextId?partPositions.viewPost+this.postContent.postNextId+"/":"javascript:void(0)"},getPrevPostUrl:function(){return 0!=this.postContent.postPrvId?partPositions.viewPost+this.postContent.postPrvId+"/":"javascript:void(0)"},goViewTag:function(tagId){window.open(partPositions.viewTag+tagId+"/")},getImageUrl:function(str){return getImageUrlFormHash(str)},getPostPrefix:function(prefixId){return getPostPrefix(prefixId)}}});function initAuthInfoEnd(user){user&&(main.authed=!0,main.authedUserInfo=user,main.authedUserId=user.id)}setLoaderFinishCallback(function(){main.loadPost()});