var main;function initAuthInfoEnd(user){main.userInfoLoaded=!0,user?(user.level!=userLevels.admin&&0==(user.privilege&userPrivileges.manageAllArchives)||(main.userHasManagePrivilege=!0),main.currentUser=user,main.loadArchive()):main.archiveLoadError="您没有权限查看此页面"}function initApp(){main=new Vue({el:"#main",data:{contentLoadStatus:contentLoadStatus,content:null,userInfoLoaded:!1,userHasManagePrivilege:!1,currentUser:null,classficationLoaded:!1,tagsLoading:!1,classesLoading:!1,contentTags:null,contentClasses:null,tableCommentAllPageSize:10,tableCommentAllLoadStatus:"notload",tableCommentAllDatas:null,tableCommentAllColumns:[{width:"30px",text:"#",useData:"name",dataName:"id"},{width:"140px",text:"用户名(ID) / IP",useData:"name",useData:"custom",customDataFunc:function(item){return item.authorName+" ("+item.authorId+") <br/> "+(item.authorIp?item.authorIp:"")}},{width:"120px",text:"时间",useData:"name",dataName:"postDate"},{width:"auto",text:"内容",useData:"custom",customDataFunc:function(item){return base64.decode(item.commentContent)}},{width:"70px",text:"操作",useSlot:!0,slotName:"marchives-slot"}],tableCommentAllPageCurrent:1,tableCommentAllPageAll:1,isNew:!1,archiveObject:null,archiveLoadError:"",archiveLoadStatus:"notload",archiveId:0,archiveType:"unknow",archiveStatus:0,archiveTags:null,archiveClass:"",archiveContent:"",archiveShowLastModifyDate:!0,mediaCenterItems:null,mediaCenterLoadStatus:"notload",mediaCenterPageCurrent:1,mediaCenterPageAll:1,mediaCenterPageSize:10,mediaCenterCurrentEditItem:null,mediaCenterCurrentEditItemOldTitle:"",mdEditor:null},watch:{archiveType(newV,oldV){"html"==newV?setTimeout(function(){main.$refs.fishHtmlEditor.init()},500):"markdown"==newV&&setTimeout(function(){main.initEditorMd()},1e3),$("#marchives-tab li:first-child a").tab("show")}},methods:{isCurrentUrlAndActive:function(page){return isCurrentUrlAndActive(page)},initEditorMd(){var tick;main.mdEditor=editormd("marchive-editormd",{width:"100%",height:main.getEditorHeight(),syncScrolling:"single",path:"/assets/libs/"}),main.mdEditor.on("change",function(){clearTimeout(tick),tick=setTimeout(function(){main.contentChanged(main.mdEditor.getMarkdown())},200)})},contentChanged(content){this.archiveContent=content},getEditorHeight:()=>$("#dashboard_content").height()-100,addTag(id){var newData={},i=0;for(var key in main.archiveTags){if(main.archiveTags[key].id==id)return void toast("已经添加这个标签了哦！","info");newData[i]=main.archiveTags[key],i++}for(var key in main.contentTags)if(main.contentTags[key].id==id){newData[i]=main.contentTags[key];break}main.archiveTags=newData},removeTag(id){var newData={};for(var key in main.archiveTags)main.archiveTags[key].id!=id&&(newData[key]=main.archiveTags[key]);main.archiveTags=newData},clearTag(){Swal.fire({type:"warning",title:"真的要清空该文章上的所有标签？",text:"",confirmButtonColor:"#d33",confirmButtonText:"确定",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{isConfirm.value&&(main.archiveTags=[],toast("清空文章标签成功","success"))})},genPostUrlName(){this.archiveObject.urlName=encodeURI(this.archiveObject.title)},gotoManageTags(){gotoPage("manage-tags",!1)},gotoManageClasses(){gotoPage("manage-classes",!1)},goView(){window.open(getPostRealUrl(archiveObject))},setArchiveType(type){Swal.fire({type:"warning",title:"真的要修改文章类型吗",text:"注意，修改文章类型以后会使用不同的编辑器，需要您手动修改文章，以保证显示正常",confirmButtonColor:"#3085d6",confirmButtonText:"确定",showCancelButton:!0,cancelButtonColor:"#aaa",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{isConfirm.value&&(main.archiveType=type,toast("修改文章类型成功！","success"))})},getPostPrefix:p=>getPostPrefix(p),getArchiveCanPublish:()=>main.archiveStatus==archiveStatus.PRIVATE||main.archiveStatus==archiveStatus.DRAFT,getArchiveCanUnPublish:()=>main.archiveStatus==archiveStatus.PUBLISH,getArchiveCanUnChange:()=>!main.isNew,loadArchive(){if(this.currentUser){var currentPostPage=getQueryString("archive");if(null==currentPostPage&&(currentPostPage=getLastUrlAgrs(location.href).arg),isNumber(currentPostPage)){main.archiveLoadStatus="loading";var url=address_blog_api+"post/"+currentPostPage+"?authPrivate=true";$.ajax({url:url,success:function(response){response.success?(main.archiveObject=response.data,response.data.content?main.archiveContent=base64.decode(response.data.content):main.archiveContent="",main.archiveId=response.data.id,main.archiveType=response.data.type,main.archiveTags=response.data.postTagNames,main.archiveStatus=response.data.status,response.data.postClass&&(main.archiveClass=response.data.postClass.split(":")[0]),main.archiveLoadStatus="loaded",main.getArchiveCanPublish()&&"click"==getQueryString("publish")&&main.publish()):(main.archiveLoadStatus="failed",main.archiveLoadError=response.message)},error:function(xhr,err){main.archiveLoadStatus="failed",main.archiveLoadError=err}})}else""==currentPostPage||"write-archive"==currentPostPage?(main.isNew=!0,main.archiveObject={author:"DreamFish",authorId:main.currentUser.id,commentCount:0,content:"",enableComment:!0,headimg:"",headimgMask:!1,id:0,postClass:"",postDate:"",postNextId:0,postNextTitle:"",postPrefix:0,postPrvId:0,postTagNames:[],previewImage:"",previewText:"",status:1,tags:"",title:"",type:"markdown",urlName:"",viewCount:0},main.archiveLoadError="",main.archiveId=0,main.archiveType="markdown",main.archiveStatus=archiveStatus.DRAFT,main.archiveTags=[],main.archiveClass="",main.archiveContent="",main.archiveLoadStatus="loaded"):(main.archiveLoadStatus="failed",main.archiveLoadError="找不到指定的文章")}},loadClassfication(){this.classficationLoaded||(this.loadClasses(!0),this.loadTags(!0),this.classficationLoaded=!0)},loadClasses(fromAuto){this.classesLoading=!0,setTimeout(function(){$.get(address_blog_api+"classes",function(response){response.success&&(main.contentClasses=response.data,main.classesLoading=!1,fromAuto||toast("刷新文章分类列表成功","success",3e3))},"json")},500)},loadTags(fromAuto){this.tagsLoading=!0,setTimeout(function(){$.get(address_blog_api+"tags",function(response){response.success&&(main.contentTags=response.data,main.tagsLoading=!1,fromAuto||toast("刷新文章标签列表成功","success",3e3))},"json")},500)},loadComments(force){if(!main.isNew&&("loaded"!=main.tableCommentAllLoadStatus||force)){main.tableCommentAllLoadStatus="loading";var url=address_blog_api+"post/"+main.archiveId+"/comments/"+(main.tableCommentAllPageCurrent-1)+"/"+main.tableCommentAllPageSize;$.ajax({url:url,success:function(response){response.success?(main.tableCommentAllDatas=response.data.content,main.tableCommentAllPageCurrent=response.data.number+1,main.tableCommentAllPageAll=response.data.totalPages,main.tableCommentAllLoadStatus="loaded"):main.tableCommentAllLoadStatus="failed"},error:function(xhr,err){main.tableCommentAllLoadStatus="failed"}})}},loadMediaCenter(force){if(!main.isNew&&("loaded"!=main.mediaCenterLoadStatus||force)){main.tableCommentAllLoadStatus="loading";var url=address_blog_api+"images/post/"+main.archiveId+"/"+(main.mediaCenterPageCurrent-1)+"/"+main.mediaCenterPageSize;$.ajax({url:url,success:function(response){response.success?(main.mediaCenterItems=response.data.content,main.mediaCenterPageCurrent=response.data.number+1,main.mediaCenterPageAll=response.data.totalPages,main.mediaCenterLoadStatus="loaded"):main.mediaCenterLoadStatus="failed"},error:function(xhr,err){main.mediaCenterLoadStatus="failed"}})}},tableGenItemIds(selItems){var delPosts={comments:[]},i=0;for(var key in selItems)delPosts.comments[i]=selItems[key].id,i++;return delPosts},tableCommentAllPagerClick(item){main.tableCommentAllPageCurrent!=item&&(main.tableCommentAllPageCurrent=item,main.loadComments(!0))},tableCommentAllPageSizeChanged(newv){main.tableAllPageSize!=newv&&(main.tableAllPageSize=newv,main.tableAllLoadStatus="notload",main.loadComments())},tableCommentAllCustomItemClick(customerControlId,item){if("del"==customerControlId)Swal.fire({type:"warning",title:"确定删除此条评论？",text:"此评论将会被删除",confirmButtonColor:"#d33",confirmButtonText:"确定",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{if(isConfirm.value){var url=address_blog_api+"post/"+main.archiveId+"/comments/"+item.id;$.ajax({url:url,type:"delete",contentType:"application/json; charset=utf-8",dataType:"json",contentType:"application/json; charset=utf-8",success:function(response){main.tableAllLoadStatus="loaded",response.success?(toast("删除所选评论成功","success"),main.loadComments(!0)):swal("删除失败",response.message,"error")},error:function(xhr,err){swal("删除失败",err,"error")}})}});else if("del-all"==customerControlId){var delComments=this.tableGenItemIds(main.$refs.tableCommentAll.getCheckedItems());if(0==Object.keys(delComments.comments).length)return void swal("没有要删除的评论","请先选择需要删除的评论","info");Swal.fire({type:"warning",title:"确定删除选中的 "+Object.keys(delComments.comments).length+" 条评论？",text:"选中的评论将会被删除",confirmButtonColor:"#d33",confirmButtonText:"确定",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{if(isConfirm.value){var url=address_blog_api+"post/"+main.archiveId+"/comments";$.ajax({url:url,type:"delete",data:JSON.stringify(delComments),contentType:"application/json; charset=utf-8",dataType:"json",contentType:"application/json; charset=utf-8",success:function(response){main.tableAllLoadStatus="loaded",response.success?(toast("删除所选评论成功","success"),main.loadComments(!0)):swal("删除失败",response.message,"error")},error:function(xhr,err){swal("删除失败",err,"error")}})}})}},mediaListAdd(link,title){if(title||(title=""),"markdown"==main.archiveType){$("#marchives-tab li:first-child a").tab("show");var objStart="!["+title+"]("+link+' "'+title+'")';if(main.mdEditor.cm.somethingSelected()){var old=main.mdEditor.cm.getSelection();main.mdEditor.cm.replaceSelection(objStart+old)}else main.mdEditor.cm.replaceSelection(objStart);setTimeout(function(){main.mdEditor.cm.refresh()},300)}else"html"==main.archiveType?($("#marchives-tab li:first-child a").tab("show"),main.$refs.fishHtmlEditor.insertOrReplace('<div class="pgc-img"><img src="'+link+'" alt="'+title+'"><p class="pgc-img-caption">'+title+"</p></div>",null,!1,!0)):toast("纯文本文章无法插入图片哦！","info",5e3)},mediaListEditTitle(item){this.mediaCenterCurrentEditItem=item,this.mediaCenterCurrentEditItemOldTitle=item.title,$("#editMediaImageDlg").modal("show")},mediaListEditTitleSave(){this.mediaCenterCurrentEditItem&&($.ajax({url:address_blog_api+"images/post/"+main.archiveId+"/"+main.mediaCenterCurrentEditItem.hash,type:"put",data:JSON.stringify(main.mediaCenterCurrentEditItem),contentType:"application/json; charset=utf-8",dataType:"json",success:function(dataObj){dataObj.success?(main.mediaCenterCurrentEditItem=dataObj.data,toast("更新图片标题成功！","success")):swal("抱歉！上传失败了!","提交时发生了错误 "+dataObj.message,"error")},error:function(e){swal("抱歉！上传失败了!","提交时发生了错误 "+e.statusText,"error")}}),this.mediaCenterCurrentEditItem=null)},mediaListShowBig(el,item){BigPicture({el:el.get(0),imgSrc:getImageUrlFormHashWithType(item.hash,item.type)})},mediaListDelete(item){Swal.fire({type:"warning",title:"真的要删除这张图片吗",html:'它将会彻底删除，<br/>注意：在文章中的图片引用需要您<span class="text-primary">手动</span>删除',confirmButtonColor:"#d33",confirmButtonText:"确定",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{isConfirm.value&&$.ajax({url:address_blog_api+"images/post/"+main.archiveId+"/"+item.hash,type:"delete",contentType:"application/json; charset=utf-8",dataType:"json",success:function(dataObj){dataObj.success?(main.loadMediaCenter(!0),toast("删除图片成功！","success")):swal("抱歉！删除失败了!","提交时发生了错误 "+dataObj.message,"error")},error:function(e){swal("抱歉！删除失败了!","提交时发生了错误 "+e.statusText,"error")}})})},mediaListCopyLink(link){$("#copyText").val(link).focus().select(),document.execCommand("copy",!1,null)?toast("复制链接成功！您可以直接在文章中粘贴使用","success",4500):toast("无法复制链接，您可以右键点击图片，选择复制图片链接","error",7500)},mediaCenterListPagerClick(item){main.mediaCenterPageCurrent!=item&&(main.mediaCenterPageCurrent=item,main.loadMediaCenter(!0))},mediaCenterListPageSizeChanged(newv){main.mediaCenterPageSize!=newv&&(main.mediaCenterPageSize=newv,main.mediaCenterLoadStatus="notload",main.loadMediaCenter())},changeUploadImage(){var uploadImage=document.getElementById("uploadImage"),fileObj=uploadImage.files[0],url=address_blog_api+"images/post/"+main.archiveId,t=toast("正在上传...","loading",-1),uploadComplete=function(evt){toastClose(t);var data=JSON.parse(evt.target.responseText);data.success?(main.loadMediaCenter(!0),toast("上传图片成功！","success",5e3)):toast("上传图片失败！"+data.message+" ( "+data.extendCode+" )","error",5e3)},uploadFailed=function uploadFailed(evt){toastClose(t),toast("上传图片失败！请检查您的网络","error",5e3)},form=new FormData;form.append("file",fileObj),xhr=new XMLHttpRequest,xhr.open("post",url,!0),xhr.onload=uploadComplete,xhr.onerror=uploadFailed,xhr.send(form),uploadImage.value=""},uploadImage(){$("#uploadImage").click()},saveValidate(){return isNullOrEmpty(this.archiveObject.title)?(swal("您必须输入文章的标题才能保存文章哦","您正在提交没有标题的文章","warning"),!0):isNullOrEmpty(this.archiveContent)?(swal("您必须输入写一些文章内容才能保存文章哦","您正在提交一篇空的文章","warning"),!0):void 0},saveSubmit(targetStatus,successCallback){if(this.saveValidate())successCallback(!1);else{this.archiveObject.type=this.archiveType;var tagsStr="-";for(var key in this.archiveTags)tagsStr+=this.archiveTags[key].id+"-";"-"!=tagsStr&&(this.archiveObject.tags=tagsStr),this.archiveShowLastModifyDate?this.archiveObject.lastmodifyDate=(new Date).format("YYYY-MM-dd HH:ii:ss"):this.archiveObject.lastmodifyDate=null,this.archiveObject.postClass=this.archiveClass,this.archiveObject.content=base64.encode(this.archiveContent),main.isNew&&(isNullOrEmpty(this.archiveObject.urlName)&&genPostUrlName(),main.currentUser&&(main.archiveObject.authorId=main.currentUser.id,isNullOrEmpty(main.currentUser.friendlyName)?isNullOrEmpty(main.currentUser.name)||(main.archiveObject.author=main.currentUser.name):main.archiveObject.author=main.currentUser.friendlyName)),-1!=targetStatus&&(this.archiveObject.status=targetStatus,this.archiveStatus=targetStatus),setTimeout(function(){if(main.isNew){var url=address_blog_api+"post";$.ajax({url:url,type:"post",data:JSON.stringify(main.archiveObject),contentType:"application/json; charset=utf-8",dataType:"json",success:function(dataObj){dataObj.success?(main.archiveObject=dataObj.data,main.archiveId=main.archiveObject.id,main.isNew=!1,successCallback()):(swal("抱歉！发表失败了!","提交时发生了错误 "+dataObj.message,"error"),successCallback(!1))},error:function(e){successCallback(!1),swal("抱歉！发表失败了!","提交时发生了错误 "+e.statusText,"error")}})}else{var url=address_blog_api+"post/"+main.archiveId;$.ajax({url:url,type:"put",data:JSON.stringify(main.archiveObject),contentType:"application/json; charset=utf-8",dataType:"json",success:function(dataObj){dataObj.success?successCallback(!0):(swal("抱歉！发表失败了!","提交时发生了错误 "+dataObj.message,"error"),successCallback(!1))},error:function(e){successCallback(!1),swal("抱歉！发表失败了!","提交时发生了错误 "+e.statusText,"error")}})}},600)}},cancelChange(){Swal.fire({type:"warning",title:"真的要放弃修改吗",text:"注意，您的未保存修改将会丢失！",confirmButtonColor:"#d33",confirmButtonText:"确定",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{isConfirm.value&&(main.loadArchive(),toast("已将文章恢复为修改前状态","success"))})},saveChange(st){Swal.fire({type:"question",title:"您真的要现在保存修改吗",text:"",confirmButtonColor:"#3085d6",confirmButtonText:"保存",showCancelButton:!0,cancelButtonColor:"#999",cancelButtonText:"再改改",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{if(isConfirm.value){var targetStatus=-1,t=toast("正在提交文章","loading",-1);"draft"==st?targetStatus=archiveStatus.DRAFT:"private"==st?targetStatus=archiveStatus.PRIVATE:"publish"==st&&(targetStatus=archiveStatus.PUBLISH),main.saveSubmit(targetStatus,function(success){toastClose(t),success&&swal("文章修改提交成功！","","success")})}})},publish(){Swal.fire({type:"warning",title:"真的要发布文章吗",text:"您的文章将会被发布",confirmButtonColor:"#3085d6",confirmButtonText:"立即发布",showCancelButton:!0,cancelButtonColor:"#999",cancelButtonText:"再改改",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{if(isConfirm.value){var t=toast("正在提交文章","loading",-1);main.saveSubmit(archiveStatus.PUBLISH,function(success){toastClose(t),success&&swal("文章发布成功！","","success")})}})},unPublish(){Swal.fire({type:"warning",title:"真的要撤回文章吗",text:"撤回后您的文章只有您自己能看到（它将被保存在草稿箱中）",confirmButtonColor:"#3085d6",confirmButtonText:"确定撤回",showCancelButton:!0,cancelButtonColor:"#999",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{if(isConfirm.value){var t=toast("正在撤回文章","loading",-1);main.saveSubmit(archiveStatus.DRAFT,function(success){toastClose(t),success&&toast("成功将文章撤回到草稿箱","success")})}})}}}),window.onbeforeunload=function(){return"请确认您的文章保存了以后再离开此页面哦！"}}appendLoaderJS("/assets/js/components/fisheditor.min.js"),appendLoaderJS("/assets/libs/compress/base64.min.js"),appendLoaderJS("/assets/libs/editormd/js/editormd.min.js"),appendLoaderCSS("/assets/libs/editormd/css/editormd.min.css"),appendLoaderJS("/assets/js/components/common-table.min.js"),appendLoaderJS("/assets/js/components/common-pagination.min.js"),appendLoaderJS("/assets/js/components/common-image-list.min.js"),appendLoaderJS("/assets/libs/BigPicture/BigPicture.min.js");