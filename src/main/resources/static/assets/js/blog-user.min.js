var main=new Vue({el:"#main",data:{currentAuthedUser:null,currentAuthed:!1,currentUserEditing:!1,currentUser:null,currentUserLoadStatus:"notload",currentUserLoadError:"",tableMessagesPageSize:10,tableMessagesLoadStatus:"notload",tableMessagesDatas:null,tableMessagesColumns:[{width:"30px",text:"#",useData:"custom",customDataFunc:function(item){if(!item.haveRead)return'<span class="badge badge-pill badge-danger">未读</span>'}},{width:"50px",text:"时间",useData:"name",dataName:"title",useLink:!0},{width:"200px",text:"内容",scroll:!0,useData:"name",useData:"custom",customDataFunc:function(item){return isNullOrEmpty(item.content)?"":base64.decode(item.content)}},{width:"90px",text:"操作",useSlot:!0,slotName:"marchives-slot"}],tableMessagesPageCurrent:1,tableMessagesPageAll:1,currentMessageTitle:"",currentMessageContent:""},methods:{loadUser:function(){var currentUserId=getQueryString("user");null==currentUserId&&(currentUserId=getLastUrlAgrs(location.href).arg),isNumber(currentUserId)&&"user"!=currentUserId||(currentUserId="0");var url=address_blog_api+"user/"+currentUserId;$.ajax({url:url,success:function(response){response.success?(main.currentUserLoadStatus="loaded",main.currentUser=response.data,main.currentAuthedUser&&main.currentAuthedUser.id==main.currentUser.id&&(main.currentAuthed=!0,isNullOrEmpty(location.hash)||0==location.hash.indexOf("#message-")&&main.messageCenter())):(main.currentUserLoadStatus="failed",main.currentUserLoadError=response.message)},error:function(xhr,err){main.currentUserLoadStatus="failed",main.currentUserLoadError=err}})},edit(){this.currentAuthedUser&&(this.currentAuthedUser.level==userLevels.writer||this.currentAuthedUser.level==userLevels.admin?location.href="/admin/user-center/":(this.currentUserEditing=!0,setTimeout(function(){"男"==main.currentUser.gender?($("#radioMale").prop("checked",!0),$("#radioFemale").prop("checked",!1)):"女"==main.currentUser.gender&&($("#radioMale").prop("checked",!1),$("#radioFemale").prop("checked",!0))},200)))},save(){var t=toast("正在提交中...","loading",-1);$.ajax({url:address_blog_api+"user/"+main.currentUser.id,type:"put",dataType:"json",data:JSON.stringify(main.currentUser),contentType:"application/json; charset=utf-8",dataType:"json",success:function(response){toastClose(t),response.success?(toast("修改个人信息成功！","success",5e3),main.currentUserEditing=!1):swal("修改个人信息失败",response.message,"error")},error:function(xhr,err){toastClose(t),toast("修改个人信息失败 : "+err,"error",5e3)}})},setGender(m){m?(main.currentUser.gender="男",$("#radioMale").prop("checked",!0),$("#radioFemale").prop("checked",!1)):(main.currentUser.gender="女",$("#radioMale").prop("checked",!1),$("#radioFemale").prop("checked",!0))},messageCenter(){this.loadMessages(),$("#messageCenterModal").modal("show")},getFriendlyName(){return this.currentUser?isNullOrEmpty(this.currentUser.friendlyName)?this.currentUser.name:this.currentUser.friendlyName:"加载失败"},getUserHead:()=>isNullOrEmpty(main.currentUser.headimg)?"/images/default/head-default.png":getImageUrlFormHash(main.currentUser.headimg),getUserCardBackground:()=>isNullOrEmpty(main.currentUser.cardBackground)?"/images/background/mebg.jpg":getImageUrlFormHash(main.currentUser.cardBackground),loadMessages(force){if("loaded"!=main.tableMessagesLoadStatus||force){main.tableMessagesLoadStatus="loading";var url=address_blog_api+"user/"+main.currentAuthedUser.id+"/messages/"+(main.tableMessagesPageCurrent-1)+"/"+main.tableMessagesPageSize;$.ajax({url:url,success:function(response){response.success?(authLoadAuthInfo(),main.tableMessagesDatas=response.data.content,main.tableMessagesPageCurrent=response.data.number+1,main.tableMessagesPageAll=response.data.totalPages,main.tableMessagesLoadStatus="loaded"):main.tableMessagesLoadStatus="failed"},error:function(xhr,err){main.tableMessagesLoadStatus="failed"}})}},deleteMessages(selItems,successCallback){var delPosts=this.tableMessagesGenItemIds(selItems);Swal.fire({type:"warning",title:"您真的要删除选中的 "+Object.keys(selItems).length+" 条消息吗?",confirmButtonColor:"#d33",confirmButtonText:"确定删除",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{isConfirm.value&&$.ajax({url:address_blog_api+"user/"+main.currentAuthedUser.id+"/messages",type:"delete",data:JSON.stringify(delPosts),contentType:"application/json; charset=utf-8",dataType:"json",contentType:"application/json; charset=utf-8",success:function(response){response.success?(toast("删除所选消息成功","success"),successCallback()):swal("删除失败",response.message,"error")},error:function(xhr,err){swal("删除失败",err,"error")}})})},readMessages(selItems,successCallback){var delPosts=this.tableMessagesGenItemIds(selItems);$.ajax({url:address_blog_api+"user/"+main.currentAuthedUser.id+"/messages/read",type:"post",data:JSON.stringify(delPosts),contentType:"application/json; charset=utf-8",dataType:"json",contentType:"application/json; charset=utf-8",success:function(response){response.success?(toast("标记已读成功","success"),successCallback()):swal("标记已读失败",response.message,"error")},error:function(xhr,err){swal("标记已读失败",err,"error")}})},read(){var selItems=this.$refs.tableMessages.getCheckedItems();selItems&&0!=Object.keys(selItems).length?this.readMessages(selItems,function(){main.loadMessages(!0)}):swal("标记已读","请至少选中一个条目！","warning")},readAll(){Swal.fire({type:"warning",title:"您真的要标记全部消息为已读吗?",confirmButtonColor:"#d33",confirmButtonText:"确定标记",showCancelButton:!0,cancelButtonColor:"#3085d6",cancelButtonText:"取消",focusCancel:!0,reverseButtons:!0}).then(isConfirm=>{isConfirm.value&&$.ajax({url:address_blog_api+"user/"+main.currentAuthedUser.id+"/messages/readall",type:"get",contentType:"application/json; charset=utf-8",success:function(response){response.success?(toast("标记全部消息为已读成功","success"),main.loadMessages(!0)):swal("全部消息为已读失败",response.message,"error")},error:function(xhr,err){swal("全部消息为已读失败",err,"error")}})})},tableMessagesItemClick(item){this.currentMessageTitle="",this.currentMessageContent="",item.content&&(this.currentMessageContent=item.content),item.title&&(this.title=item.title),$("#messageCenterModal").modal("hide"),$("#messageDatailModal").modal("show")},tableMessagesGenItemIds(selItems){var delPosts={messages:[]},i=0;for(var key in selItems)delPosts.messages[i]=selItems[key].id,i++;return delPosts},tableMessagesPagerClick(item){main.tableMessagesPageCurrent!=item&&(main.tableMessagesPageCurrent=item,main.loadMessages(!0))},tableMessagesPageSizeChanged(newv){main.tableMessagesPageSize!=newv&&(main.tableMessagesPageSize=newv,main.tableMessagesLoadStatus="notload",main.loadMessages(!0))},tableMessagesCustomItemClick(customerControlId,item){if("del-all"==customerControlId){var selItems=this.$refs.tableMessages.getCheckedItems();selItems&&0!=Object.keys(selItems).length?this.deleteMessages(selItems,function(){main.loadMessages(!0)}):swal("删除","请至少选中一个条目！","warning")}else"del"==customerControlId?this.deleteMessages([item],function(){main.loadMessages(!0)}):"read"==customerControlId&&this.readMessages([item],function(){main.loadMessages(!0)})}}});appendLoaderJS("/assets/js/components/common-table.min.js"),appendLoaderJS("/assets/js/components/common-pagination.min.js"),authSetInfoLoadFinishCallback(function(authedUser){authedUser&&(main.currentAuthedUser=authedUser,main.currentUser&&main.currentUser.id==main.currentAuthedUser.id&&(main.currentAuthed=!0))}),setLoaderFinishCallback(function(){main.loadUser()});